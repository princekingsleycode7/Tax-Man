<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Personal Income Tax Calculator</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  
<style>
  :root {
    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --card-shadow: 0 20px 40px rgba(0,0,0,0.1);
    --card-shadow-hover: 0 30px 60px rgba(0,0,0,0.15);
    --text-primary: #2d3748;
    --text-secondary: #718096;
    --border-radius: 16px;
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    min-height: 100vh;
    color: var(--text-primary);
    line-height: 1.6;
    animation: backgroundShift 10s ease-in-out infinite alternate;
  }

  @keyframes backgroundShift {
    0% { background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); }
    100% { background: linear-gradient(135deg, #764ba2 0%, #f093fb 50%, #667eea 100%); }
  }

  .main-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
    animation: slideInUp 0.8s ease-out;
  }

  @keyframes slideInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .hero-section {
    text-align: center;
    margin-bottom: 3rem;
    animation: fadeInDown 1s ease-out 0.2s both;
  }

  @keyframes fadeInDown {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .hero-title {
    font-size: clamp(2.5rem, 5vw, 4rem);
    font-weight: 700;
    background: linear-gradient(135deg, #ffffff, #f8f9fa);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 1rem;
    text-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }

  .hero-subtitle {
    font-size: 1.25rem;
    color: rgba(255,255,255,0.9);
    font-weight: 400;
    max-width: 600px;
    margin: 0 auto;
  }

  .glass-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: var(--border-radius);
    box-shadow: var(--card-shadow);
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: var(--transition);
    animation: fadeInUp 0.6s ease-out 0.4s both;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .glass-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--card-shadow-hover);
  }

  .mode-selector {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-bottom: 2rem;
    padding: 2rem;
  }

  .mode-btn {
    padding: 1rem 2rem;
    border: none;
    border-radius: 50px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
    min-width: 160px;
  }

  .mode-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: var(--transition);
  }

  .mode-btn:hover::before {
    left: 100%;
  }

  .mode-btn.active {
    background: var(--primary-gradient);
    color: white;
    transform: scale(1.05);
    box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
  }

  .mode-btn:not(.active) {
    background: rgba(255, 255, 255, 0.8);
    color: var(--text-primary);
  }

  .nav-tabs {
    border: none;
    justify-content: center;
    margin-bottom: 2rem;
  }

  .nav-tabs .nav-link {
    border: none;
    border-radius: 50px;
    margin: 0 0.5rem;
    padding: 1rem 2rem;
    font-weight: 500;
    color: var(--text-secondary);
    background: rgba(255, 255, 255, 0.7);
    transition: var(--transition);
  }

  .nav-tabs .nav-link:hover {
    background: rgba(255, 255, 255, 0.9);
    transform: translateY(-2px);
  }

  .nav-tabs .nav-link.active {
    background: var(--success-gradient);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(79, 172, 254, 0.4);
  }

  .tab-content {
    padding: 2rem;
  }

  .input-group {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    max-width: 500px;
    margin: 0 auto;
  }

  .form-label {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
  }

  .form-control, input[type="file"] {
    padding: 1rem;
    border: 2px solid rgba(0,0,0,0.1);
    border-radius: 12px;
    font-size: 1rem;
    transition: var(--transition);
    background: rgba(255, 255, 255, 0.9);
  }

  .form-control:focus, input[type="file"]:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    transform: translateY(-2px);
  }

  .btn-primary {
    background: var(--primary-gradient);
    border: none;
    border-radius: 50px;
    padding: 1rem 2rem;
    font-weight: 600;
    font-size: 1rem;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
  }

  .btn-primary::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    background: rgba(255,255,255,0.3);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
  }

  .btn-primary:hover::before {
    width: 300px;
    height: 300px;
  }

  .btn-primary:hover {
    transform: translateY(-3px);
    box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
  }

  .btn-secondary {
    background: rgba(255, 255, 255, 0.2);
    border: 2px solid rgba(255, 255, 255, 0.3);
    color: var(--text-primary);
    border-radius: 50px;
    padding: 0.75rem 1.5rem;
    font-weight: 500;
    transition: var(--transition);
  }

  .btn-secondary:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
  }

  .results-container {
    margin-top: 3rem;
  }

  .person-result {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: var(--border-radius);
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: var(--card-shadow);
    border: 1px solid rgba(255, 255, 255, 0.2);
    animation: resultSlideIn 0.6s ease-out;
    transition: var(--transition);
  }

  @keyframes resultSlideIn {
    from {
      opacity: 0;
      transform: translateX(-30px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  .person-result:hover {
    transform: translateY(-5px);
    box-shadow: var(--card-shadow-hover);
  }

  .person-result h2 {
    color: var(--text-primary);
    font-weight: 700;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 3px solid;
    border-image: var(--primary-gradient) 1;
  }

  .table-container {
    overflow-x: auto;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 12px;
    overflow: hidden;
  }

  th {
    background: var(--primary-gradient);
    color: white;
    padding: 1rem;
    font-weight: 600;
    text-align: left;
  }

  td {
    padding: 1rem;
    border-bottom: 1px solid rgba(0,0,0,0.05);
    transition: var(--transition);
  }

  tr:hover td {
    background: rgba(102, 126, 234, 0.05);
  }

  .allowance-field {
    display: flex;
    align-items: center;
    gap: 1rem;
    animation: slideInRight 0.3s ease-out;
  }

  @keyframes slideInRight {
    from {
      opacity: 0;
      transform: translateX(20px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  .remove-btn {
    background: var(--secondary-gradient);
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    color: white;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .remove-btn:hover {
    transform: scale(1.1) rotate(90deg);
  }

  .loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 1s ease-in-out infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .fade-in {
    animation: fadeIn 0.5s ease-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @media (max-width: 768px) {
    .main-container {
      padding: 1rem;
    }
    
    .mode-selector {
      flex-direction: column;
      align-items: center;
    }
    
    .mode-btn {
      width: 100%;
      max-width: 250px;
    }
    
    .nav-tabs {
      flex-direction: column;
    }
    
    .nav-tabs .nav-link {
      margin: 0.25rem 0;
    }
  }
    
    .main-container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .hero-section {
      text-align: center;
      color: white;
      margin-bottom: 2rem;
    }
    
    .hero-title {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 1rem;
    }
    
    .hero-subtitle {
      font-size: 1.2rem;
      opacity: 0.9;
    }
    
    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 2rem;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
    }
    
    .mode-selector {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      justify-content: center;
    }
    
    .mode-btn {
      padding: 12px 24px;
      border: 2px solid #667eea;
      background: transparent;
      color: #667eea;
      border-radius: 50px;
      font-weight: 600;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .mode-btn.active {
      background: #667eea;
      color: white;
    }
    
    .input-group {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .doctor-selection {
      margin: 1rem 0;
    }
    
    .radio-group {
      display: flex;
      gap: 1rem;
      margin-top: 0.5rem;
    }
    
    .radio-option {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .results-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 2rem;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }
    
    .person-result {
      margin-bottom: 2rem;
      padding: 1.5rem;
      border: 1px solid #e0e0e0;
      border-radius: 15px;
      background: rgba(255, 255, 255, 0.8);
    }
    
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin: 1rem 0;
    }
    
    .summary-item {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      padding: 1rem;
      border-radius: 10px;
      text-align: center;
    }
    
    .summary-value {
      font-size: 1.5rem;
      font-weight: 700;
    }
    
    .summary-label {
      font-size: 0.9rem;
      opacity: 0.9;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }
    
    th, td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    
    th {
      background-color: #f8f9fa;
      font-weight: 600;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #ffffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <div class="hero-section">
      <h1 class="hero-title">Personal Income Tax Calculator</h1>
      <p class="hero-subtitle">Calculate PAYE tax with precision using current or proposed Nigerian tax laws</p>
    </div>

    <div class="glass-card">
      <div class="mode-selector">
        <button class="mode-btn active" onclick="setMode('current')">
          <span>Current Law</span>
        </button>
        <button class="mode-btn" onclick="setMode('proposed')">
          <span>Proposed Law</span>
        </button>
      </div>

      <ul class="nav nav-tabs" id="inputTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="excel-tab" data-bs-toggle="tab" data-bs-target="#excel" type="button" role="tab">
            ðŸ“Š Upload Excel
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="annual-tab" data-bs-toggle="tab" data-bs-target="#annual" type="button" role="tab">
            ðŸ“… Annual Input
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="monthly-tab" data-bs-toggle="tab" data-bs-target="#monthly" type="button" role="tab">
            ðŸ’° Monthly + Allowances
          </button>
        </li>
      </ul>

      <div class="tab-content" id="tabContent">
        <!-- Excel Upload Tab -->
        <div class="tab-pane fade show active" id="excel" role="tabpanel">
          <div class="input-group">
            <label class="form-label">Upload Excel File</label>
            <input type="file" id="excelFile" accept=".xlsx, .xls" class="form-control">
            <button class="btn btn-primary" onclick="handleFileUpload()">
              <span class="btn-text">Upload & Calculate</span>
            </button>
          </div>
        </div>

        <!-- Annual Input Tab -->
        <div class="tab-pane fade" id="annual" role="tabpanel">
          <div class="input-group">
            <!-- PATCH 2: Replace name field with Pay per Annual and add doctor selection -->
            <div>
              <label for="annualPayPerAnnual" class="form-label">Pay per Annual (â‚¦)</label>
              <input type="number" id="annualPayPerAnnual" class="form-control" placeholder="0">
            </div>
            <div>
              <label for="annualGross" class="form-label">Annual Gross Salary (â‚¦)</label>
              <input type="number" id="annualGross" class="form-control" placeholder="0">
            </div>
            <div class="doctor-selection">
              <label class="form-label">Are you a doctor?</label>
              <div class="radio-group">
                <div class="radio-option">
                  <input type="radio" id="annualDoctorYes" name="annualDoctor" value="yes">
                  <label for="annualDoctorYes">Yes</label>
                </div>
                <div class="radio-option">
                  <input type="radio" id="annualDoctorNo" name="annualDoctor" value="no" checked>
                  <label for="annualDoctorNo">No</label>
                </div>
              </div>
            </div>
            <button class="btn btn-primary" onclick="handleAnnualInput()">
              <span class="btn-text">Calculate Tax</span>
            </button>
          </div>
        </div>

        <!-- Monthly + Allowances Tab -->
        <div class="tab-pane fade" id="monthly" role="tabpanel">
          <div class="input-group">
            <!-- PATCH 3: Replace name field with Pay per Annual and add doctor selection -->
            <div>
              <label for="monthlyPayPerAnnual" class="form-label">Pay per Annual (â‚¦)</label>
              <input type="number" id="monthlyPayPerAnnual" class="form-control" placeholder="0">
            </div>
            
            <div class="doctor-selection">
              <label class="form-label">Are you a doctor?</label>
              <div class="radio-group">
                <div class="radio-option">
                  <input type="radio" id="monthlyDoctorYes" name="monthlyDoctor" value="yes">
                  <label for="monthlyDoctorYes">Yes</label>
                </div>
                <div class="radio-option">
                  <input type="radio" id="monthlyDoctorNo" name="monthlyDoctor" value="no" checked>
                  <label for="monthlyDoctorNo">No</label>
                </div>
              </div>
            </div>
            <div id="allowanceContainer"></div>
            <button type="button" class="btn btn-secondary" onclick="addAllowanceField()">
              + Add Allowance
            </button>
            <button class="btn btn-primary" onclick="handleMonthlyInput()">
              <span class="btn-text">Calculate Tax</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="results" class="results-container"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    let mode = 'current';

    function setMode(selected) {
      mode = selected;
      
      // Update button states with animation
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // Clear results with fade out effect
      const resultsContainer = document.getElementById('results');
      resultsContainer.style.opacity = '0';
      setTimeout(() => {
        resultsContainer.innerHTML = '';
        resultsContainer.style.opacity = '1';
      }, 300);
    }

    function formatCurrency(value) {
      return new Intl.NumberFormat('en-NG', { 
        style: 'currency', 
        currency: 'NGN',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(value);
    }

    function showLoading(button) {
      const btnText = button.querySelector('.btn-text');
      btnText.innerHTML = '<span class="loading-spinner"></span> Calculating...';
      button.disabled = true;
    }

    function hideLoading(button, originalText) {
      const btnText = button.querySelector('.btn-text');
      btnText.textContent = originalText;
      button.disabled = false;
    }

    // PATCH 4: Updated calculateTax function with corrected PA calculation and doctor NHF logic
    function calculateTax(payPerAnnual, gross, isDoctor = false, base = 0, allowances = []) {
      // Use payPerAnnual if provided, otherwise fall back to gross salary
      const PA = payPerAnnual && payPerAnnual > 0 ? payPerAnnual : gross;
      
      // Skip NHF for doctors (H = 0), otherwise calculate 2.5% of Pay per Annual
      const H = isDoctor ? 0 : (0.025 * PA);
      
      // Calculate monthly NHF for display purposes
      const monthlyNHF = H / 12;
      
      let reliefs = 0;
      let taxable = 0;
      let brackets = [];

      if (mode === 'current') {
        // Current law: 20% relief + 200k consolidation + NHF
        reliefs = (0.2 * gross) + 200000 + H;
        taxable = Math.max(0, gross - reliefs);
        brackets = [
          [300000, 0.07], [300000, 0.11], [500000, 0.15],
          [500000, 0.19], [1600000, 0.21], [Infinity, 0.24]
        ];
      } else {
        // Proposed law: Only 200k consolidation + NHF (no 20% relief)
        reliefs = 200000 + H;
        taxable = Math.max(0, gross - reliefs);
        brackets = [
          [800000, 0.00], [2200000, 0.15], [9000000, 0.18],
          [13000000, 0.21], [25000000, 0.23], [Infinity, 0.25]
        ];
      }

      let remaining = taxable;
      let totalTax = 0;
      let rowsHTML = "";
      
      for (let [limit, rate] of brackets) {
        if (remaining <= 0) break;
        let taxedAmount = Math.min(remaining, limit);
        let tax = taxedAmount * rate;
        totalTax += tax;
        
        if (taxedAmount > 0) {
          rowsHTML += `
            <tr>
              <td>${formatCurrency(taxedAmount)}</td>
              <td>${(rate * 100).toFixed(1)}%</td>
              <td>${formatCurrency(tax)}</td>
            </tr>
          `;
        }
        remaining -= taxedAmount;
      }

      const monthlyTax = totalTax / 12;
      const netMonthly = (gross / 12) - monthlyTax;
      const effectiveRate = gross > 0 ? (totalTax / gross) * 100 : 0;
      
      let allowanceBreakdown = allowances
        .map((a, i) => a > 0 ? `<tr><td>Allowance ${i + 1}</td><td>${formatCurrency(a)}</td></tr>` : '')
        .join('');

      // PATCH 5: Updated result HTML to show Pay per Annual and monthly NHF
      const resultHTML = `
        <div class="person-result">
          <h2>Tax Calculation <span style="font-size: 0.7em; opacity: 0.7;">(${mode === 'current' ? 'Current Law' : 'Proposed Law'})</span></h2>
          
          <div class="summary-grid">
            <div class="summary-item">
              <div class="summary-value">${formatCurrency(PA)}</div>
              <div class="summary-label">Pay per Annual</div>
            </div>
            <div class="summary-item">
              <div class="summary-value">${formatCurrency(gross)}</div>
              <div class="summary-label">Annual Gross</div>
            </div>
            <div class="summary-item">
              <div class="summary-value">${formatCurrency(monthlyNHF)}</div>
              <div class="summary-label">NHF per Month</div>
            </div>
            <div class="summary-item">
              <div class="summary-value">${formatCurrency(totalTax)}</div>
              <div class="summary-label">Annual Tax</div>
            </div>
            <div class="summary-item">
              <div class="summary-value">${formatCurrency(monthlyTax)}</div>
              <div class="summary-label">Monthly Tax</div>
            </div>
            <div class="summary-item">
              <div class="summary-value">${formatCurrency(netMonthly)}</div>
              <div class="summary-label">Net Monthly</div>
            </div>
          </div>

          <table class="table">
            <thead>
              <tr>
                <th>Income Details</th>
                <th>Amount</th>
              </tr>
            </thead>
            <tbody>
              <tr><td>Annual Gross Salary</td><td>${formatCurrency(gross)}</td></tr>
              <tr><td>Pay per Annual (PA)</td><td>${formatCurrency(PA)}</td></tr>
              ${base > 0 ? `<tr><td>Base Monthly Salary</td><td>${formatCurrency(base)}</td></tr>` : ''}
              ${allowanceBreakdown}
              <tr><td>Total Relief (${mode === 'current' ? '20% + â‚¦200k + NHF' : 'â‚¦200k + NHF'})</td><td>${formatCurrency(reliefs)}</td></tr>
              <tr><td>- 20% Relief</td><td>${mode === 'current' ? formatCurrency(0.2 * gross) : 'N/A'}</td></tr>
              <tr><td>- Consolidation Relief</td><td>${formatCurrency(200000)}</td></tr>
              <tr><td>- NHF (${isDoctor ? 'Exempt - Doctor' : '2.5% of PA'})</td><td>${formatCurrency(H)}</td></tr>
              <tr><td>- NHF per Month</td><td>${formatCurrency(monthlyNHF)}</td></tr>
              <tr style="font-weight: bold;"><td>Taxable Income</td><td>${formatCurrency(taxable)}</td></tr>
              <tr style="font-weight: bold;"><td>Effective Tax Rate</td><td>${effectiveRate.toFixed(2)}%</td></tr>
            </tbody>
          </table>

          ${rowsHTML ? `
          <h3>Tax Bracket Breakdown</h3>
          <table class="table">
            <thead>
              <tr>
                <th>Taxable Amount</th>
                <th>Rate</th>
                <th>Tax</th>
              </tr>
            </thead>
            <tbody>
              ${rowsHTML}
              <tr style="font-weight: bold; background-color: #f8f9fa;">
                <td>Total</td>
                <td></td>
                <td>${formatCurrency(totalTax)}</td>
              </tr>
            </tbody>
          </table>
          ` : ''}
        </div>
      `;

      return resultHTML;
    }

    // PATCH 6: Updated handleAnnualInput to use correct variables and doctor selection
    function handleAnnualInput() {
      const button = document.querySelector('#annual .btn-primary');
      showLoading(button);
      
      setTimeout(() => {
        try {
          const payPerAnnual = parseFloat(document.getElementById('annualPayPerAnnual').value) || 0;
          const gross = parseFloat(document.getElementById('annualGross').value) || 0;
          const isDoctor = document.querySelector('input[name="annualDoctor"]:checked').value === 'yes';
          
          if (gross <= 0 && payPerAnnual <= 0) {
            alert('Please enter either Pay per Annual or Annual Gross Salary');
            return;
          }
          
          // Use gross if provided, otherwise use payPerAnnual * 12 as a fallback
          const finalGross = gross > 0 ? gross : payPerAnnual;
          
          const result = calculateTax(payPerAnnual, finalGross, isDoctor);
          document.getElementById('results').innerHTML = result;
          document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        } catch (error) {
          alert('Error calculating tax: ' + error.message);
        } finally {
          hideLoading(button, 'Calculate Tax');
        }
      }, 500);
    }

    // PATCH 7: Updated handleMonthlyInput to use correct variables and doctor selection
    function handleMonthlyInput() {
      const button = document.querySelector('#monthly .btn-primary');
      showLoading(button);
      
      setTimeout(() => {
        try {
          const payPerAnnual = parseFloat(document.getElementById('monthlyPayPerAnnual').value) || 0;
          const monthlySalary = parseFloat(document.getElementById('monthlySalary').value) || 0;
          const isDoctor = document.querySelector('input[name="monthlyDoctor"]:checked').value === 'yes';
          
          if (monthlySalary <= 0 && payPerAnnual <= 0) {
            alert('Please enter either Pay per Annual or Base Monthly Salary');
            return;
          }
          
          // Use payPerAnnual directly if provided, otherwise calculate from monthly components
let annualGross;
if (payPerAnnual > 0) {
  annualGross = payPerAnnual;
} else {
  const totalMonthlyAllowances = allowances.reduce((sum, allowance) => sum + allowance, 0);
  const totalMonthly = monthlySalary + totalMonthlyAllowances;
  annualGross = totalMonthly * 12;
    }
          
          // Calculate annual gross from monthly components
          const totalMonthlyAllowances = allowances.reduce((sum, allowance) => sum + allowance, 0);
          const totalMonthly = monthlySalary + totalMonthlyAllowances;
          const annualGross = totalMonthly * 12;
          
          const result = calculateTax(payPerAnnual, annualGross, isDoctor, monthlySalary, allowances);
          document.getElementById('results').innerHTML = result;
          document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        } catch (error) {
          alert('Error calculating tax: ' + error.message);
        } finally {
          hideLoading(button, 'Calculate Tax');
        }
      }, 500);
    }

    function addAllowanceField() {
      const container = document.getElementById('allowanceContainer');
      const allowanceCount = container.children.length + 1;
      
      const div = document.createElement('div');
div.innerHTML = `
  <div>
    <label class="form-label">Allowance ${allowanceCount} (â‚¦)</label>
    <div style="display: flex; gap: 10px; align-items: center;">
      <input type="number" class="form-control" placeholder="0" style="flex: 1;">
      <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.parentElement.parentElement.remove()">-</button>
    </div>
  </div>
`;      container.appendChild(div);
    }

    // PATCH 8: Updated handleFileUpload to process Excel with new field structure
    function handleFileUpload() {
      const fileInput = document.getElementById('excelFile');
      const file = fileInput.files[0];
      
      if (!file) {
        alert('Please select an Excel file');
        return;
      }
      
      const button = document.querySelector('#excel .btn-primary');
      showLoading(button);
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, {type: 'array'});
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet);
          
          if (jsonData.length === 0) {
            alert('No data found in Excel file');
            return;
          }
          
          let results = '';
          jsonData.forEach((row, index) => {
            try {
              // Look for various possible column headers (case insensitive)
              const payPerAnnual = parseFloat(
                row['Pay per Annual'] || 
                row['pay per annual'] || 
                row['PayPerAnnual'] || 
                row['PA'] || 
                0
              );
              
              const gross = parseFloat(
                row['Annual Gross'] || 
                row['annual gross'] || 
                row['AnnualGross'] || 
                row['Gross'] || 
                row['gross'] ||
                0
              );
              
              const isDoctor = String(
                row['Doctor'] || 
                row['doctor'] || 
                row['Is Doctor'] || 
                row['is doctor'] || 
                'no'
              ).toLowerCase() === 'yes';
              
              if (gross > 0 || payPerAnnual > 0) {
                const finalGross = gross > 0 ? gross : payPerAnnual;
                results += calculateTax(payPerAnnual, finalGross, isDoctor);
              }
            } catch (error) {
              console.error(`Error processing row ${index + 1}:`, error);
            }
          });
          
          if (results) {
            document.getElementById('results').innerHTML = results;
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
          } else {
            alert('No valid data found. Please ensure your Excel file has columns for "Pay per Annual", "Annual Gross", and optionally "Doctor" (yes/no)');
          }
          
        } catch (error) {
          alert('Error reading Excel file: ' + error.message);
        } finally {
          hideLoading(button, 'Upload & Calculate');
        }
      };
      
      reader.readAsArrayBuffer(file);
    }
  </script>
</body>
</html>
